<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UU-status – endringsarkiv</title>
  <style>
    :root {
      --bg: #0b0f14;
      --card: #11161d;
      --muted: #9fb0c3;
      --text: #e7eef7;
      --accent: #6fb3ff;
      --ok: #28a745;
      --warn: #f0ad4e;
      --bad: #dc3545;
      --border: #1f2a36;
      --focus: #9dd1ff;
      --detail-bg: #0e1420;
      --detail-accent: #2a7de1;
    }

    html, body {
      background: var(--bg);
      color: var(--text);
      font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
    }

    .wrap { max-width: 1100px; margin: 32px auto; padding: 0 16px; }
    h1 { font-size: 28px; margin: 0 0 8px; }
    .muted { color: var(--muted); }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }

    .cards {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
    }

    .toolbar {
      display: grid;
      gap: 12px;
      grid-template-columns: 1fr 160px 160px;
      align-items: end;
      margin: 18px 0 14px;
    }

    .toolbar .field { display: flex; flex-direction: column; gap: 6px; }
    .toolbar input, .toolbar select, .toolbar button {
      background: var(--card);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 10px;
      outline: none;
    }

    .toolbar input:focus, .toolbar select:focus, .toolbar button:focus {
      box-shadow: 0 0 0 3px var(--focus);
    }

    table { width: 100%; border-collapse: collapse; }
    th, td {
      padding: 10px 8px;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }

    th { text-align: left; font-weight: 600; white-space: nowrap; }
    tr:hover td { background: rgba(255,255,255,0.02); }

    details summary {
      cursor: pointer;
      color: var(--accent);
      margin-bottom: 4px;
    }

    details[open] summary {
      margin-bottom: 6px;
    }

    .footer {
      display:flex;
      justify-content: space-between;
      align-items:center;
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      gap: 12px;
      flex-wrap: wrap;
    }

    .truncate {
      max-width: 540px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: inline-block;
      vertical-align: bottom;
    }

    ul { margin: 4px 0 8px 16px; padding: 0; }
    li { margin: 0 0 3px; }

    /* --- Paginering --- */
    .pager { display:flex; justify-content: space-between; align-items:center; padding:10px 6px; gap:12px; flex-wrap:wrap; }
    .pager-left { display:flex; align-items:center; gap:8px; }
    .pager select { background: var(--card); border:1px solid var(--border); color:var(--text); padding:6px 8px; border-radius:10px; }
    .pages { display:flex; gap:6px; flex-wrap:wrap; }
    .btn-page { background:none; border:1px solid var(--border); color:var(--text); padding:6px 10px; border-radius:10px; cursor:pointer; }
    .btn-page[disabled] { opacity:.5; cursor:default; }
    .btn-page.active, .btn-page[aria-current="page"] { border-color: var(--accent); box-shadow:0 0 0 2px rgba(111,179,255,.25); }
    .pager-info { color: var(--muted); font-size: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>UU-status – endringsarkiv</h1>
    <div class="muted">
      Her ser du hvilke endringer som er oppdaget siden forrige oppdatering.
      Nye brudd, fjernede brudd og andre justeringer blir vist per nettsted.
    </div>
    <p><a href="./uu-status.html">← Til oversikten</a></p>

    <div class="toolbar" role="region" aria-label="Filtre for endringsarkiv">
      <div class="field">
        <label for="q">Søk (navn/domene/URL)</label>
        <input id="q" type="search" placeholder="Filtrer på navn, domene eller URL…" autocomplete="off" />
      </div>
      <div class="field">
        <label for="filterMode">Filtrer</label>
        <select id="filterMode">
          <option value="">Alle endringer</option>
          <option value="added">Kun nye brudd</option>
          <option value="removed">Kun fjernede brudd</option>
        </select>
      </div>
      <div class="field">
        <label for="dateFrom">Fra dato (UTC)</label>
        <input id="dateFrom" type="date" />
      </div>
    </div>

    <div class="cards" role="region" aria-label="Endringslogg">
      <table id="tbl">
        <thead>
          <tr>
            <th>Dato/tid</th>
            <th>Domene</th>
            <th>Navn</th>
            <th>+ / −</th>
            <th>Detaljer</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="5" class="muted">Laster endringer…</td></tr>
        </tbody>
      </table>

      <!-- Paginering -->
      <div class="pager" role="navigation" aria-label="Sideveksler">
        <div class="pager-left">
          <label for="pageSize" class="muted">Vis per side:</label>
          <select id="pageSize" aria-label="Velg antall rader per side" title="Antall rader per side">
            <option value="20" selected>20</option>
            <option value="30">30</option>
            <option value="40">40</option>
            <option value="50">50</option>
            <option value="all">Alle</option>
          </select>
          <span id="pageInfo" class="pager-info"></span>
        </div>
        <div class="pages" id="pagerBtns"></div>
      </div>

      <div class="footer">
        <div id="count" class="muted"></div>
        <div class="muted">Kilde: <code>docs/data/uustatus/logs/changes.jsonl</code></div>
      </div>
    </div>
  </div>

  <script type="module">
    const LOG_URL = "./data/uustatus/logs/changes.jsonl";
    const DETAILS_URL = "./uu-status-details.json";

    const tbody = document.getElementById("tbody");
    const count = document.getElementById("count");
    const q = document.getElementById("q");
    const mode = document.getElementById("filterMode");
    const dateFrom = document.getElementById("dateFrom");
    const pageSizeSel = document.getElementById("pageSize");
    const pagerBtns = document.getElementById("pagerBtns");
    const pageInfo = document.getElementById("pageInfo");

    let all = [];
    let view = [];
    let state = { q: "", mode: "", from: null };
    let page = 1;
    let pageSize = 20;

    function escapeHTML(s) {
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function canonUrl(u) {
      try {
        const a = new URL((u || '').trim());
        a.hash = ''; a.search = '';
        let host = a.hostname.toLowerCase();
        if (a.port && !((a.protocol === 'http:' && a.port === '80') || (a.protocol === 'https:' && a.port === '443'))) {
          host += `:${a.port}`;
        }
        let path = a.pathname || '';
        if (path !== '/' && path.endsWith('/')) path = path.slice(0, -1);
        return `${a.protocol}//${host}${path}`;
      } catch {
        return (u || '').trim();
      }
    }

    function cleanTitle(t) {
      if (!t) return "";
      let s = String(t).trim();
      s = s.replace(/^\s*tilgjengelighetserkl(?:æ|ae)ring\s+for\s+/i, "");
      s = s.replace(/\s*(?:[\|\u2013-])\s*uustatus\s*$/i, "");
      return s.trim();
    }

    const titleByUrl = new Map();

    async function loadTitleMap() {
      try {
        const res = await fetch(DETAILS_URL, { cache: "no-store" });
        const data = await res.json();
        const rows = Array.isArray(data) ? data : (data.urls || []);
        for (const r of rows) {
          const url = r.url || r.href;
          const rawTitle = (r.name || r.title || "");
          const title = cleanTitle(rawTitle);
          if (url && title) {
            titleByUrl.set(canonUrl(url), title);
          }
        }
      } catch (e) {
        console.warn("Kunne ikke laste tittel-kart:", e);
      }
    }

    async function fetchJSONL(url) {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("Kunne ikke hente changes.jsonl");
      const text = await res.text();
      return text.split("\n").map(l => l.trim()).filter(Boolean).map(l => JSON.parse(l));
    }

    function resolveTitle(row) {
      const key = canonUrl(row.url || "");
      const fromLog = row.title ? cleanTitle(row.title) : "";
      const fromMap = titleByUrl.get(key) || "";
      const removed = (row.changed && (row.changed.removedEntry || row.changed.removedUrl));
      const fallback = removed ? "Erklæring (fjernet)" : (row.url || "");
      return fromLog || fromMap || fallback;
    }

    function formatChanges(changed) {
      if (!changed || typeof changed !== "object") return "";
      const parts = [];
      if (changed.totalNonConformities) {
        const before = changed.totalNonConformities.before;
        const after = changed.totalNonConformities.after;
        if (before !== undefined && after !== undefined) {
          parts.push(`Antall brudd endret fra ${before} til ${after}.`);
        }
      }
      if (changed.totalWarnings) {
        parts.push(`Antall advarsler endret fra ${changed.totalWarnings.before} til ${changed.totalWarnings.after}.`);
      }
      if (changed.statementUpdatedAt) {
        parts.push("Selve erklæringen er oppdatert.");
      }
      return parts.length ? parts.join(" ") : "Andre små endringer registrert.";
    }

    function passesFilters(row, state, resolvedTitle) {
      const q = state.q;
      const hay = (resolvedTitle || "") + " " + (row.domain || "") + " " + (row.url || "");
      const hit = !q || hay.toLowerCase().includes(q);
      if (!hit) return false;
      if (state.mode === "added" && !(row.added && row.added.length > 0)) return false;
      if (state.mode === "removed" && !(row.removed && row.removed.length > 0)) return false;
      if (state.from) {
        const ts = new Date(row.ts);
        if (isNaN(ts)) return false;
        if (ts < state.from) return false;
      }
      return true;
    }

    function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }
    function buildPageList(totalPages, current) {
      if (totalPages <= 9) return Array.from({ length: totalPages }, (_, i) => i + 1);
      const pages = [1];
      const start = Math.max(2, current - 2);
      const end = Math.min(totalPages - 1, current + 2);
      if (start > 2) pages.push("…");
      for (let i = start; i <= end; i++) pages.push(i);
      if (end < totalPages - 1) pages.push("…");
      pages.push(totalPages);
      return pages;
    }

    function render() {
      tbody.innerHTML = "";
      const total = view.length;
      const isAll = (pageSize === Infinity);
      const totalPages = isAll ? 1 : Math.max(1, Math.ceil(total / pageSize));
      page = clamp(page, 1, totalPages);
      const startIdx = isAll ? 0 : (page - 1) * pageSize;
      const endIdx = isAll ? total : Math.min(startIdx + pageSize, total);
      const pageRows = view.slice(startIdx, endIdx);

      if (!pageRows.length) {
        tbody.innerHTML = `<tr><td colspan="5" class="muted">Ingen endringer på valgt filter.</td></tr>`;
        count.textContent = "";
        pageInfo.textContent = "";
        pagerBtns.innerHTML = "";
        return;
      }

      for (const r of pageRows) {
        const plus = (r.added?.length || 0);
        const minus = (r.removed?.length || 0);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${new Date(r.ts).toLocaleString("no-NO")}</td>
          <td>${escapeHTML(r.domain || "")}</td>
          <td>${r.url ? `<a class="truncate" href="${escapeHTML(r.url)}" target="_blank" rel="noopener noreferrer">${escapeHTML(resolveTitle(r))}</a>` : `<span class="truncate">${escapeHTML(resolveTitle(r))}</span>`}</td>
          <td>+${plus} / −${minus}</td>
          <td></td>
        `;
        const tdDet = tr.lastElementChild;
        const det = document.createElement("details");
        const sum = document.createElement("summary");
        sum.textContent = "Vis detaljer";
        det.appendChild(sum);

        const secAdded = document.createElement("div");
        secAdded.innerHTML = "<strong>Nye brudd:</strong>" +
          (plus ? `<ul>${r.added.map(x => `<li>${escapeHTML(x)}</li>`).join("")}</ul>` : " <span class='muted'>Ingen</span>");
        det.appendChild(secAdded);

        const secRemoved = document.createElement("div");
        secRemoved.innerHTML = "<strong>Fjernede brudd:</strong>" +
          (minus ? `<ul>${r.removed.map(x => `<li>${escapeHTML(x)}</li>`).join("")}</ul>` : " <span class='muted'>Ingen</span>");
        det.appendChild(secRemoved);

        if (r.changed && Object.keys(r.changed).length) {
          const hdr = document.createElement("div");
          hdr.innerHTML = "<strong>Andre endringer:</strong> " + escapeHTML(formatChanges(r.changed));
          det.appendChild(hdr);
        }

        const snapLink = document.createElement("div");
        const yyyyMmDd = (r.updatedDate || (r.ts || "").slice(0,10));
        snapLink.style.marginTop = ".5rem";
        snapLink.innerHTML = `
          <div class="muted" style="margin-bottom:.25rem;">Sist oppdatert (fra erklæring): ${escapeHTML(yyyyMmDd || "")}</div>
          <a href="./data/uustatus/snapshots_by_updated/${escapeHTML(yyyyMmDd || "")}.json" target="_blank" rel="noopener">
            Åpne snapshot ${escapeHTML(yyyyMmDd || "")}
          </a>`;
        det.appendChild(snapLink);

        tdDet.appendChild(det);
        tbody.appendChild(tr);
      }

      count.textContent = `${total} endringer`;
      const a = isAll ? 1 : startIdx + 1;
      const b = isAll ? total : endIdx;
      pageInfo.textContent = `Viser ${a}–${b} av ${total}`;

      pagerBtns.innerHTML = "";
      if (!isAll && totalPages > 1) {
        const makeBtn = (txt, label, disabled, onClick) => {
          const b = document.createElement("button");
          b.className = "btn-page";
          b.textContent = txt;
          if (label) b.setAttribute("aria-label", label);
          b.disabled = !!disabled;
          if (!disabled) b.addEventListener("click", onClick);
          return b;
        };
        pagerBtns.appendChild(makeBtn("«","Første side",page===1,()=>{page=1;render();}));
        pagerBtns.appendChild(makeBtn("‹","Forrige side",page===1,()=>{page--;render();}));
        for (const p of buildPageList(totalPages,page)) {
          if (p==="…") {
            const dot=document.createElement("span");dot.className="btn-page";dot.textContent="…";pagerBtns.appendChild(dot);
          } else {
            const b=makeBtn(String(p),null,false,()=>{page=p;render();});
            if (p===page) b.setAttribute("aria-current","page");
            pagerBtns.appendChild(b);
          }
        }
        pagerBtns.appendChild(makeBtn("›","Neste side",page===totalPages,()=>{page++;render();}));
        pagerBtns.appendChild(makeBtn("»","Siste side",page===totalPages,()=>{page=totalPages;render();}));
      }
    }

    async function init(){
      try {
        await loadTitleMap();
        all = await fetchJSONL(LOG_URL);
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="5" class="muted">Feil ved lasting: ${escapeHTML(e.message)}</td></tr>`;
        return;
      }

      function apply(){
        view = all
          .map(r => ({ row: r, title: resolveTitle(r) }))
          .filter(({row, title}) => passesFilters(row, state, title))
          .sort((a,b) => new Date(b.row.ts) - new Date(a.row.ts))
          .map(({row}) => row);
        render();
      }

      q.addEventListener("input", () => { state.q = q.value.trim().toLowerCase(); apply(); });
      mode.addEventListener("change", () => { state.mode = mode.value; apply(); });
      dateFrom.addEventListener("change", () => { state.from = dateFrom.value ? new Date(dateFrom.value + "T00:00:00Z") : null; apply(); });
      pageSizeSel.addEventListener("change", () => {
        const v = pageSizeSel.value;
        pageSize = v === "all" ? Infinity : parseInt(v);
        page = 1;
        render();
      });

      apply();
    }

    init();
  </script>
</body>
</html>
